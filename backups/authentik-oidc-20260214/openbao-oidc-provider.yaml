version: 1
metadata:
  name: OpenBao OIDC Provider
  labels:
    purpose: certificate-authority-authentication
    managed-by: claude

entries:
  # OpenBao OAuth2/OIDC Provider
  - model: authentik_providers_oauth2.oauth2provider
    identifiers:
      name: openbao-oidc-provider
    attrs:
      client_type: confidential
      client_id: openbao-client-2026
      authorization_flow: !Find [authentik_flows.flow, [slug, default-provider-authorization-explicit-consent]]
      redirect_uris: |
        https://openbao.funlab.casa:8088/ui/vault/auth/oidc/oidc/callback
        https://openbao.funlab.casa:8088/oidc/callback
        http://localhost:8250/oidc/callback
      property_mappings:
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, openid]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, email]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, profile]]
        - !Find [authentik_providers_oauth2.scopemapping, [scope_name, offline_access]]
      sub_mode: hashed_user_id
      include_claims_in_id_token: true
      issuer_mode: per_provider
      signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]

  # OpenBao Application
  - model: authentik_core.application
    identifiers:
      slug: openbao
    attrs:
      name: OpenBao
      provider: !Find [authentik_providers_oauth2.oauth2provider, [name, openbao-oidc-provider]]
      meta_launch_url: https://openbao.funlab.casa:8088/ui/
      meta_description: OpenBao secrets management and PKI
      meta_publisher: Infrastructure Team
      policy_engine_mode: any
